<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --modal-bg: rgba(0,0,0,0.95);
            --button-bg: rgba(255,255,255,0.15);
            --button-bg-hover: rgba(255,255,255,0.25);
            --button-text: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .header {
            background: var(--bg-primary);
            padding: 0.75rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-left { display: flex; align-items: center; gap: 0.75rem; }
        .header-icon { width: 28px; height: 28px; }
        .header-content h1 { font-size: 1.5rem; margin: 0; line-height: 1.2; }
        .header-path { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.15rem; }
        .info { font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .progress-bar-container {
            height: 3px;
            background: rgba(0,0,0,0.1);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            overflow: hidden;
            display: none;
        }
        .progress-bar-container.active { display: block; }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
            width: 0%;
        }
        .progress-text {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .header-actions { display: flex; gap: 0.5rem; align-items: center; }
        .header-btn {
            width: 36px;
            height: 36px;
            border: 1px solid rgba(0,0,0,0.1);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .header-btn:hover { background: #e9ecef; }
        .gallery-sections { padding: 0 2rem 2rem; }
        .gallery-section { margin-bottom: 2rem; }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--text-primary);
            margin-bottom: 1rem;
        }
        .gallery { column-count: 5; column-gap: 15px; }
        .gallery-item {
            break-inside: avoid;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            background: var(--bg-primary);
        }
        .gallery-item:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .gallery-item img { width: 100%; height: auto; display: block; transition: opacity 0.3s; }
        .gallery-item img.loading { opacity: 0.6; filter: blur(8px); }
        .gallery-item .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0,0,0,0.1);
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }
        .gallery-item.loading .loader { display: block; }
        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
        .heart-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
            z-index: 10;
        }
        .gallery-item:hover .heart-btn { opacity: 1; }
        .heart-btn.hearted { opacity: 1; }
        .heart-btn svg { width: 18px; height: 18px; }
        .heart-btn:hover { transform: scale(1.1); background: rgba(255,255,255,1); }
        .heart-btn.hearted svg { fill: #e74c3c; stroke: #e74c3c; }
        .heart-btn:not(.hearted) svg { fill: none; stroke: #666; }
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: var(--modal-bg);
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-image {
            max-width: 90%; max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            cursor: grab;
        }
        .modal-image.panning { cursor: grabbing; }
        .modal-video { max-width: 90%; max-height: 90%; border-radius: 8px; }
        /* Round, Visible Close Button */
        .close {
            position: fixed; top: 20px; right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--button-bg); backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            color: var(--button-text); font-size: 28px;
            cursor: pointer; z-index: 2001;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .close:hover { background: var(--button-bg-hover); transform: scale(1.1) rotate(90deg); box-shadow: 0 6px 20px rgba(0,0,0,0.6); }
        .zoom-controls {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: none; gap: 12px; z-index: 2001;
        }
        .zoom-controls.active { display: flex; }
        .zoom-btn {
            width: 48px; height: 48px; border-radius: 50%;
            background: var(--button-bg); backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            color: var(--button-text); font-size: 22px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .zoom-btn:hover { background: var(--button-bg-hover); transform: scale(1.15); box-shadow: 0 6px 20px rgba(0,0,0,0.6); }
        .zoom-btn.hearted svg { fill: #e74c3c; stroke: #e74c3c; }
        .zoom-btn:not(.hearted) svg { fill: none; }
        .zoom-info {
            position: fixed; top: 30px; left: 30px;
            background: var(--button-bg); backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            color: var(--button-text); padding: 10px 20px; border-radius: 24px;
            font-size: 14px; font-weight: 600; z-index: 2001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: none;
        }
        .zoom-info.active { display: block; }
        @media (max-width: 1200px) { .gallery { column-count: 4; } }
        @media (max-width: 900px) { .gallery { column-count: 3; } }
        @media (max-width: 600px) { .gallery { column-count: 2; } }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <svg class="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
            </svg>
            <div class="header-content">
                <h1>Gallery</h1>
                <div class="header-path" id="gallery-path"></div>
                <div class="info" id="gallery-info">Loading...</div>
                <div class="progress-text" id="progress-text"></div>
            </div>
        </div>
        <div class="header-actions">
            <button class="header-btn" id="fullscreenBtn" onclick="toggleFullscreen()" title="Fullscreen">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                </svg>
            </button>
            <button class="header-btn" id="themeBtn" onclick="toggleTheme()" title="Toggle Theme">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
            <button class="header-btn" id="pauseBtn" style="display:none;" onclick="togglePause()" title="Pause Generation">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="6" y="4" width="4" height="16"></rect>
                    <rect x="14" y="4" width="4" height="16"></rect>
                </svg>
            </button>
            <button class="header-btn" id="rescanBtn" onclick="rescanGallery()" title="Rescan Gallery">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg>
            </button>
            <button class="header-btn" id="filterHeartsBtn" onclick="toggleHeartFilter()" title="Show Favorites">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
            </button>
        </div>
        <div class="progress-bar-container" id="progressBarContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>
    <div class="gallery-sections" id="gallerySections"></div>
    <div class="modal" id="imageModal">
        <div class="close" id="closeModal">✕</div>
        <div class="zoom-info" id="zoomInfo">100%</div>
        <img class="modal-image" id="modalImage" style="display: none;">
        <video class="modal-video" id="modalVideo" controls style="display: none;"></video>
        <div class="zoom-controls" id="zoomControls">
            <button class="zoom-btn" id="heartBtn" title="Favorite">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
            </button>
            <button class="zoom-btn" id="zoomOut">−</button>
            <button class="zoom-btn" id="resetZoom">⌂</button>
            <button class="zoom-btn" id="zoomIn">+</button>
        </div>
    </div>
    <script>
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        const modalVideo = document.getElementById('modalVideo');
        const zoomControls = document.getElementById('zoomControls');
        const zoomInfo = document.getElementById('zoomInfo');
        let scale = 1, translateX = 0, translateY = 0, isDragging = false, lastX = 0, lastY = 0;
        const thumbnailCache = new Map();
        let heartedImages = new Set();
        let currentModalMedia = null;
        let showOnlyHearted = false;
        let thumbnailsPaused = false;
        
        function loadHearts() {
            const saved = localStorage.getItem('heartedImages');
            if (saved) {
                heartedImages = new Set(JSON.parse(saved));
            }
        }
        
        function saveHearts() {
            localStorage.setItem('heartedImages', JSON.stringify(Array.from(heartedImages)));
        }
        
        function toggleHeart(relativePath, element) {
            if (heartedImages.has(relativePath)) {
                heartedImages.delete(relativePath);
            } else {
                heartedImages.add(relativePath);
            }
            saveHearts();
            if (element) {
                element.classList.toggle('hearted', heartedImages.has(relativePath));
            }
            updateHeartButton();
            if (showOnlyHearted) {
                filterByHearts();
            }
        }
        
        function updateHeartButton() {
            const heartBtn = document.getElementById('heartBtn');
            if (heartBtn && currentModalMedia) {
                heartBtn.classList.toggle('hearted', heartedImages.has(currentModalMedia.relativePath));
            }
        }
        
        function toggleHeartFilter() {
            showOnlyHearted = !showOnlyHearted;
            const btn = document.getElementById('filterHeartsBtn');
            if (showOnlyHearted) {
                btn.style.background = '#e74c3c';
                btn.style.color = '#fff';
                btn.querySelector('svg').style.fill = '#fff';
            } else {
                btn.style.background = '';
                btn.style.color = '';
                btn.querySelector('svg').style.fill = '';
            }
            filterByHearts();
        }
        
        function filterByHearts() {
            document.querySelectorAll('.gallery-section').forEach(section => {
                const items = section.querySelectorAll('.gallery-item');
                let visibleCount = 0;
                items.forEach(item => {
                    const relativePath = item.dataset.relativePath;
                    if (showOnlyHearted) {
                        if (heartedImages.has(relativePath)) {
                            item.style.display = '';
                            visibleCount++;
                        } else {
                            item.style.display = 'none';
                        }
                    } else {
                        item.style.display = '';
                        visibleCount++;
                    }
                });
                section.style.display = visibleCount > 0 ? '' : 'none';
            });
        }
        
        async function loadGallery() {
            loadHearts();
            const response = await fetch('/api/gallery');
            const data = await response.json();
            document.getElementById('gallery-info').textContent = 'Found ' + data.totalImages + ' media files';
            document.getElementById('gallery-path').textContent = data.scanDirectory;
            
            const sectionsContainer = document.getElementById('gallerySections');
            
            // Sort directories for consistent display
            const sortedDirs = Object.keys(data.galleries).sort();
            
            sortedDirs.forEach(dir => {
                const media = data.galleries[dir];
                
                // Create section
                const section = document.createElement('div');
                section.className = 'gallery-section';
                
                // Create section title
                const title = document.createElement('div');
                title.className = 'section-title';
                title.textContent = dir === '.' ? 'Root' : dir;
                section.appendChild(title);
                
                // Create gallery grid for this section
                const gallery = document.createElement('div');
                gallery.className = 'gallery';
                
                media.forEach(item => {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';
                    galleryItem.dataset.relativePath = item.relativePath;
                    
                    const heartBtn = document.createElement('button');
                    heartBtn.className = 'heart-btn';
                    if (heartedImages.has(item.relativePath)) heartBtn.classList.add('hearted');
                    heartBtn.innerHTML = '<svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>';
                    heartBtn.onclick = (e) => { e.stopPropagation(); toggleHeart(item.relativePath, heartBtn); };
                    galleryItem.appendChild(heartBtn);
                    
                    const loader = document.createElement('div');
                    loader.className = 'loader';
                    galleryItem.appendChild(loader);
                    
                    const img = document.createElement('img');
                    if (item.thumbnail) {
                        img.src = item.thumbnail;
                    } else {
                        galleryItem.classList.add('loading');
                        img.classList.add('loading');
                        img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="300" height="200"%3E%3Crect width="300" height="200" fill="%23f0f0f0"/%3E%3C/svg%3E';
                    }
                    img.alt = item.name;
                    img.loading = 'lazy';
                    galleryItem.appendChild(img);
                    galleryItem.onclick = () => openModal(item);
                    gallery.appendChild(galleryItem);
                    
                    thumbnailCache.set(item.relativePath, { element: galleryItem, img: img, data: item });
                });
                
                section.appendChild(gallery);
                sectionsContainer.appendChild(section);
            });
            
            connectSSE();
        }
        
        function connectSSE() {
            const eventSource = new EventSource('/progress');
            
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'request_viewport_items') {
                    reportViewportItems();
                }
                
                if (data.type === 'thumbnail_paused') {
                    thumbnailsPaused = data.isPaused;
                    updatePauseButton();
                }
                
                if (data.type === 'tiny_preview_ready' && data.media) {
                    const cached = thumbnailCache.get(data.media.relativePath);
                    if (cached && data.media.tinyPreview) {
                        cached.img.src = data.media.tinyPreview;
                        cached.img.classList.add('loading');
                    }
                }
                
                if (data.type === 'thumbnail_ready' && data.media) {
                    const cached = thumbnailCache.get(data.media.relativePath);
                    if (cached && data.media.thumbnail) {
                        cached.img.src = data.media.thumbnail;
                        cached.img.classList.remove('loading');
                        cached.element.classList.remove('loading');
                        cached.data.thumbnail = data.media.thumbnail;
                    }
                }
                
                if (data.type === 'global_thumbnail_progress') {
                    const progressBar = document.getElementById('progressBar');
                    const progressContainer = document.getElementById('progressBarContainer');
                    const progressText = document.getElementById('progress-text');
                    const pauseBtn = document.getElementById('pauseBtn');
                    const rescanBtn = document.getElementById('rescanBtn');
                    
                    if (data.isGenerating) {
                        progressContainer.classList.add('active');
                        progressBar.style.width = data.progress + '%';
                        progressText.textContent = 'Generating: ' + data.completed + '/' + data.total + ' (' + data.currentFile + ')';
                        pauseBtn.style.display = '';
                        rescanBtn.style.display = 'none';
                    } else {
                        setTimeout(() => {
                            progressContainer.classList.remove('active');
                            progressText.textContent = '';
                            pauseBtn.style.display = 'none';
                            rescanBtn.style.display = '';
                            thumbnailsPaused = false;
                        }, 1000);
                    }
                }
            };
            
            eventSource.onerror = () => {
                console.log('SSE lost, reconnecting...');
                eventSource.close();
                setTimeout(connectSSE, 3000);
            };
        }
        
        function reportViewportItems() {
            const viewportItems = [];
            document.querySelectorAll('.gallery-item').forEach(item => {
                const rect = item.getBoundingClientRect();
                const isVisible = rect.top < window.innerHeight + 500 && rect.bottom > -500;
                if (isVisible && item.dataset.relativePath) {
                    const cached = thumbnailCache.get(item.dataset.relativePath);
                    if (cached && !cached.data.thumbnail) {
                        viewportItems.push(item.dataset.relativePath);
                    }
                }
            });
            
            if (viewportItems.length > 0) {
                fetch('/api/viewport-items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ relativePaths: viewportItems })
                }).catch(e => console.log('Failed to report viewport items'));
            }
        }
        
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                reportViewportItems();
            }, 200);
        });
        
        function updatePauseButton() {
            const pauseBtn = document.getElementById('pauseBtn');
            const svg = pauseBtn.querySelector('svg');
            if (thumbnailsPaused) {
                pauseBtn.title = 'Resume Generation';
                svg.setAttribute('fill', 'none');
                svg.setAttribute('stroke', 'currentColor');
                svg.setAttribute('stroke-width', '2');
                svg.setAttribute('stroke-linecap', 'round');
                svg.setAttribute('stroke-linejoin', 'round');
                svg.innerHTML = '<polygon points="5 3 19 12 5 21 5 3"></polygon>';
            } else {
                pauseBtn.title = 'Pause Generation';
                svg.setAttribute('fill', 'none');
                svg.setAttribute('stroke', 'currentColor');
                svg.setAttribute('stroke-width', '2');
                svg.setAttribute('stroke-linecap', 'round');
                svg.setAttribute('stroke-linejoin', 'round');
                svg.innerHTML = '<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>';
            }
        }
        
        async function togglePause() {
            try {
                const response = await fetch('/api/pause-thumbnails', { method: 'POST' });
                const data = await response.json();
                thumbnailsPaused = data.isPaused;
                updatePauseButton();
            } catch (e) {
                console.log('Failed to toggle pause');
            }
        }
        
        async function rescanGallery() {
            const btn = document.getElementById('rescanBtn');
            btn.style.opacity = '0.5';
            btn.style.pointerEvents = 'none';
            try {
                await fetch('/api/rescan', { method: 'POST' });
                window.location.reload();
            } catch (e) {
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            }
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function toggleTheme() {
            const root = document.documentElement;
            const current = root.style.getPropertyValue('--bg-primary') || '#ffffff';
            if (current === '#ffffff') {
                root.style.setProperty('--bg-primary', '#1a1a1a');
                root.style.setProperty('--bg-secondary', '#2d2d2d');
                root.style.setProperty('--text-primary', '#e0e0e0');
                root.style.setProperty('--text-secondary', '#a0a0a0');
            } else {
                root.style.setProperty('--bg-primary', '#ffffff');
                root.style.setProperty('--bg-secondary', '#f8f9fa');
                root.style.setProperty('--text-primary', '#2c3e50');
                root.style.setProperty('--text-secondary', '#7f8c8d');
            }
        }
        
        function openModal(media) {
            currentModalMedia = media;
            if (media.type === 'video') {
                modalImg.style.display = 'none';
                modalVideo.style.display = 'block';
                modalVideo.src = media.url;
                zoomControls.classList.remove('active');
                zoomInfo.classList.remove('active');
            } else {
                modalVideo.style.display = 'none';
                modalImg.style.display = 'block';
                modalImg.src = media.url;
                zoomControls.classList.add('active');
                zoomInfo.classList.add('active');
                resetZoom();
            }
            modal.classList.add('active');
            updateHeartButton();
        }
        
        function closeModal() {
            modal.classList.remove('active');
            if (modalVideo.style.display === 'block') { modalVideo.pause(); modalVideo.src = ''; }
            modalImg.src = ''; resetZoom();
        }
        
        function zoom(delta) {
            scale = Math.max(0.1, Math.min(5, scale + delta));
            modalImg.style.transform = 'translate(' + translateX + 'px, ' + translateY + 'px) scale(' + scale + ')';
            zoomInfo.textContent = Math.round(scale * 100) + '%';
        }
        
        function resetZoom() { scale = 1; translateX = 0; translateY = 0; zoom(0); }
        
        document.getElementById('closeModal').onclick = closeModal;
        modal.onclick = (e) => { if (e.target === modal) closeModal(); };
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
        document.getElementById('zoomIn').onclick = () => zoom(0.2);
        document.getElementById('zoomOut').onclick = () => zoom(-0.2);
        document.getElementById('resetZoom').onclick = resetZoom;
        document.getElementById('heartBtn').onclick = () => {
            if (currentModalMedia) {
                toggleHeart(currentModalMedia.relativePath, document.getElementById('heartBtn'));
                const cached = thumbnailCache.get(currentModalMedia.relativePath);
                if (cached) {
                    const heartBtn = cached.element.querySelector('.heart-btn');
                    if (heartBtn) heartBtn.classList.toggle('hearted', heartedImages.has(currentModalMedia.relativePath));
                }
            }
        };
        modalImg.addEventListener('wheel', (e) => { e.preventDefault(); zoom(e.deltaY > 0 ? -0.1 : 0.1); });
        modalImg.addEventListener('mousedown', (e) => { if (scale > 1) { isDragging = true; lastX = e.clientX; lastY = e.clientY; e.preventDefault(); } });
        document.addEventListener('mousemove', (e) => { if (isDragging) { translateX += e.clientX - lastX; translateY += e.clientY - lastY; lastX = e.clientX; lastY = e.clientY; zoom(0); } });
        document.addEventListener('mouseup', () => { isDragging = false; });
        loadGallery();
    </script>
</body>
</html>